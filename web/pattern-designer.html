<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>LED Pattern Designer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: #1a1a1a;
      color: #fff;
      padding: 10px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      margin-bottom: 10px;
      font-size: 24px;
      color: #00ffff;
    }

    .info {
      text-align: center;
      margin-bottom: 10px;
      font-size: 14px;
      color: #888;
    }

    .version {
      color: #0f0;
      font-size: 12px;
    }

    .canvas-container {
      background: #000;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      position: relative;
      width: 100%;
      overflow: hidden;
    }

    #canvas {
      display: block;
      width: 100%;
      height: auto;
      image-rendering: pixelated;
      cursor: crosshair;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    button {
      padding: 12px;
      font-size: 16px;
      border: 2px solid #444;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 600;
      background: #2a2a2a;
      color: #fff;
    }

    button:active {
      transform: scale(0.95);
    }

    button.active {
      border-color: #00ffff;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }

    .draw-btn {
      background: #4CAF50;
    }

    .erase-btn {
      background: #f44336;
    }

    .fill-btn {
      background: #2196F3;
    }

    .clear-btn {
      background: #FF9800;
    }

    .upload-btn {
      background: #9C27B0;
      font-size: 18px;
      grid-column: 1 / -1;
    }

    .color-picker {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #2a2a2a;
      border: 2px solid #444;
      border-radius: 8px;
      padding: 8px;
      position: relative;
    }

    #colorPicker {
      width: 100%;
      height: 50px;
      border: 2px solid #fff;
      border-radius: 4px;
      cursor: pointer;
    }

    .settings {
      background: #2a2a2a;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .setting-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .setting-row:last-child {
      margin-bottom: 0;
    }

    label {
      font-weight: 600;
    }

    input[type="text"],
    input[type="number"] {
      padding: 8px;
      font-size: 14px;
      border: 1px solid #444;
      border-radius: 4px;
      background: #1a1a1a;
      color: #fff;
      width: 200px;
    }

    .status {
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      margin-top: 15px;
      font-weight: 600;
      display: none;
    }

    .status.success {
      background: #4CAF50;
    }

    .status.error {
      background: #f44336;
    }

    .status.info {
      background: #2196F3;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 20px;
      }

      .controls {
        grid-template-columns: repeat(2, 1fr);
      }

      input[type="text"],
      input[type="number"] {
        width: 150px;
      }
    }

    .tabs {
      display: flex;
      margin-bottom: 15px;
      border-bottom: 2px solid #444;
    }

    .tab-btn {
      flex: 1;
      padding: 10px;
      background: #2a2a2a;
      border: none;
      border-bottom: 3px solid transparent;
      color: #888;
      cursor: pointer;
      font-size: 16px;
      border-radius: 8px 8px 0 0;
      margin-right: 5px;
    }

    .tab-btn.active {
      background: #333;
      color: #fff;
      border-bottom-color: #00ffff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üé® LED Pattern Designer</h1>
    <div class="info">144 √ó 9 Grid | Zigzag Wiring</div>
    <div class="version">v3.0 - Cross-Platform | Build: 2025-11-23-22:15</div>

    <div class="canvas-container">
      <canvas id="canvas"></canvas>
    </div>

    <div class="controls">
      <button class="draw-btn active" onclick="setTool('draw')">‚úèÔ∏è Draw</button>
      <button class="erase-btn" onclick="setTool('erase')">üßπ Erase</button>
      <button class="fill-btn" onclick="fillAll()">üé® Fill</button>
      <button class="clear-btn" onclick="clearCanvas()">üóëÔ∏è Clear</button>
      <div class="color-picker">
        <input type="color" id="colorPicker" value="#ff0000">
      </div>
    </div>

    <div class="settings">
      <div class="setting-row">
        <label>Scroll Speed:</label>
        <input type="number" id="scrollSpeed" value="80" min="20" max="200">
      </div>
    </div>

    <button class="upload-btn" onclick="uploadToESP()">üöÄ Upload to ESP8266</button>
    <div id="status" class="status"></div>

    <hr style="margin: 20px 0; border-color: #333;">

    <h2>üåà Standard Patterns</h2>

    <div class="tabs">
      <button class="tab-btn active" onclick="openTab('tab-1d')">1D Patterns</button>
      <button class="tab-btn" onclick="openTab('tab-2d')">2D Patterns</button>
      <button class="tab-btn" onclick="openTab('tab-text')">Text</button>
      <button class="tab-btn" onclick="openTab('tab-basic')">Basic</button>
    </div>

    <div id="tab-1d" class="tab-content active">
      <!-- ... (1D controls) ... -->

      <div class="controls">
        <button onclick="setPattern(0)">Rainbow Loop</button>
        <button onclick="setPattern(10)">Rainbow Glitter</button>
        <button onclick="setPattern(11)">Candy Cane</button>
        <button onclick="setPattern(12)">Theater Chase</button>
        <button onclick="setPattern(13)">Matrix Rain</button>
        <button onclick="setPattern(14)">Twinkle</button>
        <button onclick="setPattern(15)">Police Lights</button>
        <button onclick="setPattern(16)">Running Lights</button>
        <button onclick="setPattern(17)">Snow Sparkle</button>
        <button onclick="setPattern(18)">Color Wipe</button>
        <button onclick="setPattern(19)">Color Pulse</button>

        <button onclick="setPattern(20)">Lightning</button>
        <button onclick="setPattern(21)">Ocean Waves</button>
        <button onclick="setPattern(22)">Lava Lamp</button>
        <button onclick="setPattern(23)">Meteor Rain</button>
        <button onclick="setPattern(24)">Pride</button>
        <button onclick="setPattern(25)">Heartbeat</button>
        <button onclick="setPattern(26)">Comet</button>
        <button onclick="setPattern(27)">Gradient</button>
        <button onclick="setPattern(28)">Random Colors</button>
        <button onclick="setPattern(29)">Knight Rider</button>

        <button onclick="setPattern(30)">Breathing</button>
        <button onclick="setPattern(31)">Strobe</button>
        <button onclick="setPattern(32)">Pac-Man</button>
        <button onclick="setPattern(33)">Bouncing Balls</button>
        <button onclick="setPattern(34)">USA Flag</button>
        <button onclick="setPattern(35)">Christmas</button>
        <button onclick="setPattern(36)">Plasma</button>
        <button onclick="setPattern(37)">Scanner</button>
        <button onclick="setPattern(38)">Sparkle</button>
        <button onclick="setPattern(39)">Color Chase</button>

        <button onclick="setPattern(40)">Rainbow Wave</button>
        <button onclick="setPattern(41)">Dragon Breath</button>
        <button onclick="setPattern(42)">Aurora</button>
        <button onclick="setPattern(43)">Disco Ball</button>
        <button onclick="setPattern(44)">Waterfall</button>
        <button onclick="setPattern(45)">Neon Signs</button>
        <button onclick="setPattern(46)">Traffic Light</button>
        <button onclick="setPattern(47)">Binary Code</button>
        <button onclick="setPattern(48)">Rave</button>
        <button onclick="setPattern(49)">Sunset</button>
        <button onclick="setPattern(50)">Campfire</button>
        <button onclick="setPattern(51)">Sparkler</button>
        <button onclick="setPattern(52)">Lighthouse</button>
        <button onclick="setPattern(53)">SOS Morse</button>
        <button onclick="setPattern(54)">Meteor Shower</button>
        <button onclick="setPattern(55)">Rainbow Spiral</button>
        <button onclick="setPattern(56)">Lava Flow</button>
        <button onclick="setPattern(57)">Ice Cave</button>
        <button onclick="setPattern(58)">Fireflies</button>
        <button onclick="setPattern(59)">Circus</button>

        <button onclick="setPattern(60)">Warp Speed</button>
        <button onclick="setPattern(61)">Radar Sweep</button>
        <button onclick="setPattern(62)">Equalizer Bars</button>
        <button onclick="setPattern(63)">Snake</button>
        <button onclick="setPattern(64)">Pulse Wave</button>
        <button onclick="setPattern(65)">Color Explosion</button>
        <button onclick="setPattern(66)">Digital Rain</button>
        <button onclick="setPattern(67)">Heartbeat Wave</button>
        <button onclick="setPattern(68)">Thunderstorm</button>
        <button onclick="setPattern(69)">Rainbow Fade</button>
        <button onclick="setPattern(70)">Disco Strobe</button>
        <button onclick="setPattern(71)">Biohazard</button>
        <button onclick="setPattern(72)">Ocean Depth</button>
        <button onclick="setPattern(73)">Pixel Sort</button>
        <button onclick="setPattern(74)">Glitch</button>
        <button onclick="setPattern(75)">Tron</button>
        <button onclick="setPattern(76)">Ember</button>
        <button onclick="setPattern(77)">Aurora Borealis</button>
        <button onclick="setPattern(78)">Neon Pulse</button>
        <button onclick="setPattern(79)">Rainbow Ripple</button>

        <button onclick="setPattern(80)">Kaleidoscope</button>
        <button onclick="setPattern(81)">DNA Helix</button>
        <button onclick="setPattern(82)">Fireworks</button>
        <button onclick="setPattern(83)">VU Meter</button>
        <button onclick="setPattern(84)">Spinning Wheel</button>
        <button onclick="setPattern(85)">Color Bands</button>
        <button onclick="setPattern(86)">Starfield</button>
        <button onclick="setPattern(87)">Binary Counter</button>
        <button onclick="setPattern(88)">Breathing Rainbow</button>
        <button onclick="setPattern(89)">Wave Interference</button>
        <button onclick="setPattern(90)">Bouncing Ball</button>
        <button onclick="setPattern(91)">Color Temperature</button>
        <button onclick="setPattern(92)">Police Siren</button>
        <button onclick="setPattern(93)">Candy Stripes</button>
        <button onclick="setPattern(94)">Pixel Rain</button>
        <button onclick="setPattern(95)">Energy Field</button>
        <button onclick="setPattern(96)">Orbit</button>
        <button onclick="setPattern(97)">Pulse Ring</button>
        <button onclick="setPattern(98)">Random Walk</button>
        <button onclick="setPattern(99)">Supernova</button>

        <button onclick="setPattern(5)">Confetti</button>
        <button onclick="setPattern(6)">Sinelon (Cylon)</button>
        <button onclick="setPattern(7)">BPM Pulse</button>
        <button onclick="setPattern(8)">Juggle</button>
        <button onclick="setPattern(9)">Fire</button>
      </div>
    </div>

    <div id="tab-2d" class="tab-content">
      <div class="controls">
        <button onclick="setPattern(100)">Horizontal Bars</button>
        <button onclick="setPattern(101)">Vertical Ripple</button>
        <button onclick="setPattern(102)">2D Fire Rising</button>
        <button onclick="setPattern(103)">Rain Drops</button>
        <button onclick="setPattern(104)">Vertical Equalizer</button>
        <button onclick="setPattern(105)">Scanning Lines</button>
        <button onclick="setPattern(106)">Checkerboard</button>
        <button onclick="setPattern(107)">Diagonal Sweep</button>
        <button onclick="setPattern(108)">Vertical Wave</button>
        <button onclick="setPattern(109)">Plasma 2D</button>

        <button onclick="setPattern(110)">Matrix Rain 2D</button>
        <button onclick="setPattern(111)">Game of Life</button>
        <button onclick="setPattern(112)">Wave Pool</button>
        <button onclick="setPattern(113)">Aurora 2D</button>
        <button onclick="setPattern(114)">Lava Lamp 2D</button>
        <button onclick="setPattern(115)">2D Ripple</button>
        <button onclick="setPattern(116)">Starfield Parallax</button>
        <button onclick="setPattern(117)">Side Fire</button>
        <button onclick="setPattern(118)">Scrolling Rainbow</button>
        <button onclick="setPattern(119)">Particle Fountain</button>
        <button onclick="setPattern(121)">Test Card</button>
      </div>
    </div>

    <div id="tab-text" class="tab-content">
      <div class="settings">
        <div class="setting-row">
          <label>Message:</label>
          <input type="text" id="scrollText" value="HELLO WORLD" style="text-transform: uppercase;">
        </div>
        <button class="upload-btn" onclick="sendText()">üìú Send Text</button>
      </div>
    </div>

    <div id="tab-basic" class="tab-content">
      <div class="controls">
        <button style="background:#ff4444" onclick="setPattern(1)">Red</button>
        <button style="background:#44ff44; color:black" onclick="setPattern(2)">Green</button>
        <button style="background:#4444ff" onclick="setPattern(3)">Blue</button>
        <button style="background:#555" onclick="setPattern(4)">‚ö´ Turn Off</button>
      </div>
    </div>
  </div>

  <script>
    const GRID_WIDTH = 144;
    const GRID_HEIGHT = 9;
    const CELL_WIDTH = 10;
    const CELL_HEIGHT = 72; // ~7.2:1 aspect ratio (50mm / 6.9mm)

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // Update canvas size
    canvas.width = GRID_WIDTH * CELL_WIDTH;
    canvas.height = GRID_HEIGHT * CELL_HEIGHT;

    let currentTool = 'draw';
    let currentColor = '#ff0000';
    let isDrawing = false;

    // Pattern data: 2D array of RGB values
    let pattern = Array(GRID_HEIGHT).fill(null).map(() =>
      Array(GRID_WIDTH).fill(null).map(() => [0, 0, 0])
    );

    // Initialize
    function init() {
      clearCanvas();
      setupEvents();
    }

    // Unified pointer event handler (works for both mouse and touch)
    function getGridCoordinates(clientX, clientY) {
      const rect = canvas.getBoundingClientRect();

      // Calculate scale factor
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;

      // Get position on canvas
      const canvasX = (clientX - rect.left) * scaleX;
      const canvasY = (clientY - rect.top) * scaleY;

      // Convert to grid coordinates
      const x = Math.floor(canvasX / CELL_WIDTH);
      const y = Math.floor(canvasY / CELL_HEIGHT);

      return { x, y };
    }

    function handlePointerDown(clientX, clientY) {
      isDrawing = true;
      drawPixel(clientX, clientY);
    }

    function handlePointerMove(clientX, clientY) {
      if (!isDrawing) return;
      drawPixel(clientX, clientY);
    }

    function handlePointerUp() {
      isDrawing = false;
    }

    function drawPixel(clientX, clientY) {
      const { x, y } = getGridCoordinates(clientX, clientY);

      if (x >= 0 && x < GRID_WIDTH && y >= 0 && y < GRID_HEIGHT) {
        if (currentTool === 'draw') {
          pattern[y][x] = hexToRgb(currentColor);
        } else if (currentTool === 'erase') {
          pattern[y][x] = [0, 0, 0];
        }
        redrawCanvas();
      }
    }

    function setupEvents() {
      // Mouse events
      canvas.addEventListener('mousedown', (e) => {
        e.preventDefault();
        handlePointerDown(e.clientX, e.clientY);
      });

      canvas.addEventListener('mousemove', (e) => {
        handlePointerMove(e.clientX, e.clientY);
      });

      canvas.addEventListener('mouseup', () => handlePointerUp());
      canvas.addEventListener('mouseleave', () => handlePointerUp());

      // Touch events
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        handlePointerDown(touch.clientX, touch.clientY);
      });

      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const touch = e.touches[0];
        handlePointerMove(touch.clientX, touch.clientY);
      });

      canvas.addEventListener('touchend', () => handlePointerUp());

      // Color picker
      document.getElementById('colorPicker').addEventListener('change', (e) => {
        currentColor = e.target.value;
      });
    }

    function setTool(tool) {
      currentTool = tool;
      document.querySelectorAll('.controls button').forEach(btn => btn.classList.remove('active'));
      if (tool === 'draw') document.querySelector('.draw-btn').classList.add('active');
      if (tool === 'erase') document.querySelector('.erase-btn').classList.add('active');
    }

    function clearCanvas() {
      pattern = Array(GRID_HEIGHT).fill(null).map(() =>
        Array(GRID_WIDTH).fill(null).map(() => [0, 0, 0])
      );
      redrawCanvas();
    }

    function fillAll() {
      const rgb = hexToRgb(currentColor);
      pattern = Array(GRID_HEIGHT).fill(null).map(() =>
        Array(GRID_WIDTH).fill(null).map(() => [...rgb])
      );
      redrawCanvas();
    }

    function redrawCanvas() {
      // Clear canvas
      ctx.fillStyle = '#000000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Draw pixels (with gaps)
      // We draw the LED as a square (CELL_WIDTH x CELL_WIDTH) centered vertically in the cell
      const ledHeight = CELL_WIDTH; // Square pixels
      const yOffset = (CELL_HEIGHT - ledHeight) / 2;

      for (let y = 0; y < GRID_HEIGHT; y++) {
        for (let x = 0; x < GRID_WIDTH; x++) {
          const [r, g, b] = pattern[y][x];

          // Draw the LED as a circle centered in the cell
          const centerX = x * CELL_WIDTH + CELL_WIDTH / 2;
          const centerY = y * CELL_HEIGHT + yOffset + ledHeight / 2;
          const radius = (CELL_WIDTH / 2) - 1; // Slightly smaller than cell width for padding

          ctx.beginPath();
          ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);

          // Draw the "off" state
          ctx.fillStyle = '#222';
          ctx.fill();

          // Outline
          ctx.strokeStyle = '#444';
          ctx.lineWidth = 1;
          ctx.stroke();

          if (r > 0 || g > 0 || b > 0) {
            ctx.fillStyle = `rgb(${r}, ${g}, ${b})`;
            ctx.fill();
          }
        }
      }

      // Draw grid (lanes)
      ctx.strokeStyle = '#222';
      ctx.lineWidth = 1;

      // Vertical lines (every 10 pixels)
      for (let x = 0; x <= GRID_WIDTH; x++) {
        ctx.beginPath();
        ctx.moveTo(x * CELL_WIDTH, 0);
        ctx.lineTo(x * CELL_WIDTH, canvas.height);
        ctx.stroke();
      }

      // Horizontal lines (every 72 pixels - showing the strips)
      for (let y = 0; y <= GRID_HEIGHT; y++) {
        ctx.beginPath();
        ctx.moveTo(0, y * CELL_HEIGHT);
        ctx.lineTo(canvas.width, y * CELL_HEIGHT);
        ctx.stroke();
      }
    }

    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? [
        parseInt(result[1], 16),
        parseInt(result[2], 16),
        parseInt(result[3], 16)
      ] : [255, 0, 0];
    }

    function openTab(tabName) {
      // Hide all tab content
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      // Deactivate all tab buttons
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

      // Show selected tab content
      document.getElementById(tabName).classList.add('active');
      // Activate selected tab button
      event.currentTarget.classList.add('active');
    }

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = 'status ' + type;
      statusDiv.style.display = 'block';
      setTimeout(() => statusDiv.style.display = 'none', 5000);
    }

    async function setPattern(mode) {
      showStatus(`Setting pattern ${mode}...`, 'info');
      try {
        // Use local proxy endpoint
        const response = await fetch(`/api/set?m=${mode}`);
        if (response.ok) {
          showStatus(`‚úÖ Pattern ${mode} set!`, 'success');
        } else {
          showStatus('‚ùå Failed to set pattern', 'error');
        }
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
      }
    }

    async function uploadToESP() {
      const scrollSpeed = parseInt(document.getElementById('scrollSpeed').value);

      showStatus('Uploading...', 'info');

      try {
        // Convert to dense hex format (RRGGBB)
        let hexData = "";
        let pixelCount = 0;

        for (let y = 0; y < GRID_HEIGHT; y++) {
          if (y % 2 === 0) {
            // Even rows: left to right
            for (let x = 0; x < GRID_WIDTH; x++) {
              const [r, g, b] = pattern[y][x];
              hexData += ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
              if (r > 0 || g > 0 || b > 0) pixelCount++;
            }
          } else {
            // Odd rows: right to left (zigzag)
            for (let x = GRID_WIDTH - 1; x >= 0; x--) {
              const [r, g, b] = pattern[y][x];
              hexData += ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
              if (r > 0 || g > 0 || b > 0) pixelCount++;
            }
          }
        }

        const payload = JSON.stringify({
          hex: hexData,
          scrollSpeed: scrollSpeed
        });

        // Log to debug server
        try {
          await fetch('http://192.168.1.132:8080/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: payload
          });
        } catch (e) { /* Ignore if log server not running */ }

        // Send to ESP8266 via local proxy
        const response = await fetch(`/api/uploadPattern`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: payload
        });

        if (response.ok) {
          showStatus(`‚úÖ Uploaded ${pixelCount} pixels!`, 'success');
        } else {
          showStatus('‚ùå Upload failed: ' + response.statusText, 'error');
        }
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
      }
    }

    async function sendText() {
      const text = document.getElementById('scrollText').value;
      const speed = document.getElementById('scrollSpeed').value;

      showStatus(`Sending text: ${text}...`, 'info');
      try {
        const response = await fetch(`/api/setText?text=${encodeURIComponent(text)}&speed=${speed}`);
        if (response.ok) {
          showStatus('‚úÖ Text sent!', 'success');
        } else {
          showStatus('‚ùå Failed to send text', 'error');
        }
      } catch (error) {
        showStatus('‚ùå Error: ' + error.message, 'error');
      }
    }

    // Start
    init();
  </script>
</body>

</html>