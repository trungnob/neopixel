<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LED Pattern Simulator (WASM)</title>
  <style>
    :root {
      --bg: #0e1118;
      --panel: #161b27;
      --accent: #27e0a3;
      --accent-2: #4aa3ff;
      --text: #e7eefc;
      --muted: #8ea0c2;
      --danger: #ff6289;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: "Inter", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(39,224,163,0.08), transparent 35%), radial-gradient(circle at 80% 0%, rgba(74,163,255,0.1), transparent 30%), var(--bg);
      color: var(--text);
      display: flex;
      height: 100vh;
    }
    .sidebar {
      width: 320px;
      background: var(--panel);
      border-right: 1px solid rgba(255,255,255,0.06);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
    }
    .content {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.2px;
    }
    .panel {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 10px;
      padding: 12px;
    }
    .label-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    select, input[type="text"], input[type="range"], button {
      width: 100%;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      border-radius: 8px;
      padding: 10px;
      font-size: 14px;
      outline: none;
    }
    button {
      cursor: pointer;
      transition: background 0.15s ease, transform 0.15s ease;
    }
    button:hover { background: rgba(39,224,163,0.12); }
    button:active { transform: translateY(1px); }
    .btn-row { display: flex; gap: 8px; }
    .btn { flex: 1; }
    canvas {
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      image-rendering: pixelated;
      background: #1b1f2c;
      width: 100%;
      height: auto;
      aspect-ratio: 16 / 1.8;
    }
    .stats {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--muted);
    }
    .tag {
      background: rgba(255,255,255,0.06);
      border-radius: 999px;
      padding: 4px 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--accent);
      display: inline-block;
    }
    @media (max-width: 900px) {
      body { flex-direction: column; }
      .sidebar { width: 100%; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.06); }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h1>WASM LED Simulator</h1>
    <div class="panel">
      <div class="label-row">
        <span>Pattern</span>
        <span id="pattern-id" aria-live="polite"></span>
      </div>
      <select id="pattern-select" aria-label="Pattern select"></select>
      <div style="margin-top:10px;">
        <div class="label-row">
          <span>Scroll speed (text)</span>
          <span id="speed-label">80ms</span>
        </div>
        <input id="speed" type="range" min="20" max="200" value="80" />
      </div>
      <div style="margin-top:10px;">
        <div class="label-row">
          <span>Scroll text</span>
          <span id="text-len" aria-live="polite"></span>
        </div>
        <input id="scroll-text" type="text" value="HELLO WORLD" maxlength="100" />
      </div>
      <div class="btn-row" style="margin-top:10px;">
        <button class="btn" id="apply-text">Update Text</button>
        <button class="btn" id="randomize">Randomize Seed</button>
      </div>
      <div class="btn-row" style="margin-top:10px;">
        <button class="btn" id="play-pause">Pause</button>
        <button class="btn" id="step">Step</button>
      </div>
    </div>
    <div class="panel stats" id="stats">
      <div class="tag"><span class="dot"></span><span id="fps">FPS: --</span></div>
      <div class="tag">LEDs: 1296</div>
      <div class="tag">Grid: 144 × 9</div>
    </div>
  </div>

  <div class="content">
    <div class="panel" style="flex:1; display:flex; align-items:center; justify-content:center;">
      <canvas id="canvas" width="144" height="9"></canvas>
    </div>
  </div>

  <script type="module">
    import createSim from '../../artifacts/simulator/sim-core.js';

    const GRID_WIDTH = 144;
    const GRID_HEIGHT = 9;
    const LED_SPACING_H = 6.9;
    const LED_SPACING_V = 50.0;
    const ASPECT = LED_SPACING_V / LED_SPACING_H; // vertical:horizontal scale

    const patterns = [
      { id: 100, name: 'Horizontal Bars' },
      { id: 101, name: 'Vertical Ripple' },
      { id: 102, name: '2D Fire Rising' },
      { id: 103, name: 'Rain Drops' },
      { id: 104, name: 'Vertical Equalizer' },
      { id: 105, name: 'Scanning Lines' },
      { id: 106, name: 'Checkerboard' },
      { id: 107, name: 'Diagonal Sweep' },
      { id: 108, name: 'Vertical Wave' },
      { id: 109, name: 'Plasma 2D' },
      { id: 110, name: 'Matrix Rain 2D' },
      { id: 111, name: 'Game of Life' },
      { id: 112, name: 'Wave Pool' },
      { id: 113, name: 'Aurora 2D' },
      { id: 114, name: 'Lava Lamp 2D' },
      { id: 115, name: '2D Ripple' },
      { id: 116, name: 'Starfield Parallax' },
      { id: 117, name: 'Side Fire' },
      { id: 118, name: 'Scrolling Rainbow' },
      { id: 119, name: 'Particle Fountain' },
      { id: 120, name: 'Scrolling Text' },
      { id: 121, name: 'Test Card' },
    ];

    const $ = (id) => document.getElementById(id);
    const canvas = $('canvas');
    canvas.width = GRID_WIDTH;
    canvas.height = Math.round(GRID_HEIGHT * ASPECT);
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;

    const bufCanvas = document.createElement('canvas');
    bufCanvas.width = GRID_WIDTH;
    bufCanvas.height = GRID_HEIGHT;
    const bufCtx = bufCanvas.getContext('2d');
    const img = bufCtx.createImageData(GRID_WIDTH, GRID_HEIGHT);
    const patternSelect = $('pattern-select');
    const patternIdLabel = $('pattern-id');
    const fpsLabel = $('fps');
    const speedInput = $('speed');
    const speedLabel = $('speed-label');
    const textInput = $('scroll-text');
    const textLen = $('text-len');
    const applyTextBtn = $('apply-text');
    const randomBtn = $('randomize');
    const playPauseBtn = $('play-pause');
    const stepBtn = $('step');

    let sim = null;
    let running = true;
    let lastTime = performance.now();
    let fpsCounter = { frames: 0, last: performance.now() };

    function updateFps(now) {
      fpsCounter.frames++;
      if (now - fpsCounter.last >= 1000) {
        const fps = Math.round((fpsCounter.frames * 1000) / (now - fpsCounter.last));
        fpsLabel.textContent = `FPS: ${fps}`;
        fpsCounter.frames = 0;
        fpsCounter.last = now;
      }
    }

    function renderFrame(now) {
      if (running) {
        const delta = now - lastTime;
        lastTime = now;
        sim._sim_step(delta | 0);

        const ptr = sim._sim_get_buffer();
        const len = sim._sim_get_buffer_length();
        const buf = sim.HEAPU8.subarray(ptr, ptr + len);

        for (let i = 0, j = 0; i < len; i += 3, j += 4) {
          img.data[j] = buf[i];
          img.data[j + 1] = buf[i + 1];
          img.data[j + 2] = buf[i + 2];
          img.data[j + 3] = 255;
        }
        bufCtx.putImageData(img, 0, 0);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(bufCanvas, 0, 0, canvas.width, canvas.height);
        updateFps(now);
      }
      requestAnimationFrame(renderFrame);
    }

    function setPattern(id) {
      sim._sim_set_pattern(id);
      patternIdLabel.textContent = `#${id}`;
    }

    function applyText() {
      const txt = textInput.value || '';
      textLen.textContent = `${txt.length}/100`;
      sim._sim_set_text(txt);
    }

    async function main() {
      sim = await createSim();
      sim._sim_init(GRID_WIDTH, GRID_HEIGHT);
      sim._sim_seed(Date.now() & 0xffffffff);

      patterns.forEach((p) => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.id} – ${p.name}`;
        patternSelect.appendChild(opt);
      });
      patternSelect.value = '100';
      setPattern(100);

      patternSelect.addEventListener('change', (e) => setPattern(parseInt(e.target.value, 10)));

      speedInput.addEventListener('input', (e) => {
        const val = parseInt(e.target.value, 10);
        speedLabel.textContent = `${val}ms`;
        sim._sim_set_scroll_speed(val);
      });

      textInput.addEventListener('input', applyText);
      applyTextBtn.addEventListener('click', applyText);

      randomBtn.addEventListener('click', () => {
        const seed = (Math.random() * 0xffffffff) >>> 0;
        sim._sim_seed(seed);
      });

      playPauseBtn.addEventListener('click', () => {
        running = !running;
        playPauseBtn.textContent = running ? 'Pause' : 'Resume';
        lastTime = performance.now();
      });

      stepBtn.addEventListener('click', () => {
        running = false;
        playPauseBtn.textContent = 'Resume';
        sim._sim_step(16);
      });

      // initial text/state
      sim._sim_set_scroll_speed(parseInt(speedInput.value, 10));
      applyText();

      requestAnimationFrame(renderFrame);
    }

    main();
  </script>
</body>
</html>
